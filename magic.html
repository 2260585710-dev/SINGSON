<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>çº¹æ ·ç²’å­é‡æ„ç³»ç»Ÿ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: sans-serif; }
        
        /* UI é¢æ¿ */
        #ui-container {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            z-index: 100;
            width: 220px;
        }
        
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #00ffcc; }
        
        .status-dot {
            display: inline-block; width: 10px; height: 10px; 
            border-radius: 50%; background: #555; margin-right: 5px;
        }
        .active { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        
        #loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffcc; font-size: 20px; text-align: center;
            pointer-events: none; transition: opacity 0.5s;
        }
        
        input[type="range"] { width: 100%; margin: 10px 0; }
        
        /* éšè—è§†é¢‘æº */
        .input_video { display: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

    <div id="ui-container">
        <h3>ğŸŒŒ ç²’å­é‡æ„</h3>
        <div style="font-size: 12px; color: #ccc; margin-bottom: 15px;">
            <span id="cam-status" class="status-dot"></span>
            <span id="status-text">æ­£åœ¨åˆå§‹åŒ–...</span>
        </div>
        
        <label style="font-size:12px;">ç²’å­å¤§å°</label>
        <input type="range" id="sizeSlider" min="1" max="5" step="0.1" value="2">

        <label style="font-size:12px;">ç²’å­é¢œè‰²</label>
        <input type="color" id="colorPicker" value="#ffffff" style="width:100%; border:none; height:30px;">
        
        <p style="font-size: 11px; color: #888; margin-top:10px; line-height: 1.5;">
            âœ‹ <b>å¼ å¼€æ‰‹æŒ</b>ï¼šç²’å­ç‚¸è£‚<br>
            âœŠ <b>æ¡ç´§æ‹³å¤´</b>ï¼šè¿˜åŸå›¾åƒ
        </p>
    </div>

    <div id="loading">æ­£åœ¨è¯»å–çº¹æ ·æ•°æ®...<br><span style="font-size:12px; color:#666">è¯·ç¨å€™</span></div>
    <video class="input_video"></video>

    <script>
        // --- 1. åŸºç¡€åœºæ™¯è®¾ç½® ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 100; // æ‘„åƒæœºè·ç¦»ï¼Œå¤ªè¿‘çœ‹ä¸åˆ°å…¨å›¾

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- 2. æ ¸å¿ƒï¼šä»å›¾ç‰‡ç”Ÿæˆç²’å­ ---
        let particles;
        let originalPositions = []; // è®°ä½æ¯ä¸ªç²’å­â€œåº”è¯¥åœ¨â€çš„ä½ç½®
        let randomTargets = [];     // ç²’å­â€œçˆ†ç‚¸åâ€é£å»çš„ä½ç½®
        
        // åŠ è½½ä½ çš„å›¾ç‰‡
        const img = new Image();
        img.src = './overlay.png'; // è‡ªåŠ¨è¯»å–ä½ çš„çº¹æ ·
        img.crossOrigin = "Anonymous"; // é˜²æ­¢è·¨åŸŸæŠ¥é”™

        img.onload = function() {
            document.getElementById('loading').innerText = "æ­£åœ¨ç”Ÿæˆç²’å­...";
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ç”»å¸ƒæ¥è¯»å–åƒç´ 
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // é™åˆ¶å°ºå¯¸ï¼Œé˜²æ­¢ç²’å­å¤ªå¤šå¡æ­» (å®½200åƒç´ å¤Ÿäº†)
            const scale = 200 / img.width; 
            canvas.width = 200;
            canvas.height = img.height * scale;
            
            // æŠŠå›¾ç‰‡ç”»åœ¨ç”»å¸ƒä¸Š
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // è·å–æ‰€æœ‰åƒç´ é¢œè‰²æ•°æ®
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;

            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];

            const colorVar = new THREE.Color();

            // éå†åƒç´ 
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const i = (y * canvas.width + x) * 4;
                    const alpha = data[i + 3];

                    // åªæœ‰å½“è¿™ä¸ªç‚¹ä¸æ˜¯é€æ˜çš„ï¼Œæ‰ç”Ÿæˆç²’å­
                    if (alpha > 20) {
                        // è®¡ç®—åæ ‡ (è®©å›¾åƒå±…ä¸­)
                        const pX = x - canvas.width / 2;
                        const pY = -(y - canvas.height / 2); // Yè½´åè½¬
                        const pZ = 0;

                        positions.push(pX, pY, pZ);
                        
                        // è®°å½•åŸå§‹ä½ç½® (æ‹¼æˆå›¾çš„æ ·å­)
                        originalPositions.push(pX, pY, pZ);

                        // è®°å½•çˆ†ç‚¸ä½ç½® (éšæœºé£æ•£)
                        randomTargets.push(
                            (Math.random() - 0.5) * 400, // æ•£å¾—æ›´å¼€
                            (Math.random() - 0.5) * 400,
                            (Math.random() - 0.5) * 200
                        );

                        // æå–åŸå›¾é¢œè‰²
                        colorVar.setRGB(data[i]/255, data[i+1]/255, data[i+2]/255);
                        colors.push(colorVar.r, colorVar.g, colorVar.b);
                    }
                }
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            // åˆ›å»ºæè´¨ (ç®€å•çš„å‘å…‰ç‚¹)
            const material = new THREE.PointsMaterial({
                size: 2,
                vertexColors: true, // ä½¿ç”¨å›¾ç‰‡åŸæœ¬çš„é¢œè‰²
                transparent: true,
                opacity: 0.9,
                sizeAttenuation: true
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
            
            document.getElementById('loading').style.opacity = 0; // éšè—åŠ è½½å­—
        };

        // --- 3. æ‰‹åŠ¿æ§åˆ¶é€»è¾‘ ---
        let handOpenness = 0; // 0=é—­åˆ(è¿˜åŸ), 1=å¼ å¼€(çˆ†ç‚¸)

        function onResults(results) {
            const statusText = document.getElementById('status-text');
            const camDot = document.getElementById('cam-status');

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                statusText.innerText = "å·²è¿æ¥æ‰‹åŠ¿";
                statusText.style.color = "#00ff00";
                camDot.classList.add('active');

                // è®¡ç®—æ‰‹æŒ‡å¼ å¼€ç¨‹åº¦
                const landmarks = results.multiHandLandmarks[0];
                const thumb = landmarks[4];
                const index = landmarks[8];
                
                // å¤§æ‹‡æŒ‡å’Œé£ŸæŒ‡è·ç¦»
                const dist = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));
                
                // æ˜ å°„ä¸€ä¸‹ï¼šè·ç¦» > 0.2 ç®—å¼ å¼€ï¼Œ < 0.05 ç®—é—­åˆ
                let val = (dist - 0.05) * 4; 
                handOpenness = Math.max(0, Math.min(1, val)); // é™åˆ¶åœ¨0-1
                
            } else {
                statusText.innerText = "è¯·ä¸¾èµ·æ‰‹æŒ";
                statusText.style.color = "#ccc";
                camDot.classList.remove('active');
                // æ²¡æ‰‹çš„æ—¶å€™ï¼Œç¼“æ…¢å½’ä½
                handOpenness = handOpenness * 0.9; 
            }
        }

        // --- 4. åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);

            if (particles) {
                const positions = particles.geometry.attributes.position.array;
                
                // æ ¹æ®æ‰‹åŠ¿è®¡ç®—ç›®æ ‡æ··åˆåº¦
                // æ‰‹å¼ å¼€è¶Šå¤§ï¼Œç²’å­è¶Šè¶‹å‘ randomTargets (ä¹±é£)
                // æ‰‹é—­åˆï¼Œç²’å­è¶Šè¶‹å‘ originalPositions (åŸå›¾)
                
                for (let i = 0; i < positions.length; i += 3) {
                    // ç›®æ ‡ X = åŸå›¾X + (çˆ†ç‚¸X - åŸå›¾X) * å¼ å¼€åº¦
                    const tx = originalPositions[i] + (randomTargets[i] - originalPositions[i]) * handOpenness;
                    const ty = originalPositions[i+1] + (randomTargets[i+1] - originalPositions[i+1]) * handOpenness;
                    const tz = originalPositions[i+2] + (randomTargets[i+2] - originalPositions[i+2]) * handOpenness;

                    // ç¼“åŠ¨åŠ¨ç”»ï¼šæ¯å¸§ç§»åŠ¨ 10% çš„è·ç¦»
                    positions[i] += (tx - positions[i]) * 0.1;
                    positions[i+1] += (ty - positions[i+1]) * 0.1;
                    positions[i+2] += (tz - positions[i+2]) * 0.1;
                }
                
                particles.geometry.attributes.position.needsUpdate = true;
                
                // å¾®å¾®æ—‹è½¬æ•´ä¸ªåœºæ™¯ï¼Œå¢åŠ 3Dæ„Ÿ
                particles.rotation.y += 0.002;
            }

            renderer.render(scene, camera);
        }
        animate();

        // --- 5. æ‘„åƒå¤´åˆå§‹åŒ– ---
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const videoElement = document.getElementsByClassName('input_video')[0];
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cameraUtils.start();

        // --- UI äº‹ä»¶ ---
        document.getElementById('sizeSlider').addEventListener('input', (e) => {
            if(particles) particles.material.size = e.target.value;
        });
        
        document.getElementById('colorPicker').addEventListener('input', (e) => {
             // å¦‚æœæƒ³å¼ºè¡ŒæŸ“æˆå•è‰²ï¼Œå–æ¶ˆæ³¨é‡Šä¸‹é¢è¿™è¡Œã€‚
             // ä½†ä¸ºäº†ä¿ç•™ä½ åŸå›¾çš„è‰²å½©ï¼Œè¿™é‡Œæˆ‘è®©å®ƒä»…ä»…å åŠ ä¸€ç‚¹é¢œè‰²ï¼Œæˆ–è€…ä½ å¯ä»¥ç•™ç™½
             if(particles) {
                particles.material.color.set(e.target.value);
                particles.material.vertexColors = false; // åˆ‡æ¢ä¸ºçº¯è‰²æ¨¡å¼
             }
        });
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
