<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AR çº¯å‡€è°ƒå‚ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        
        /* æ‘„åƒå¤´å°çª— */
        #input-video {
            position: absolute; bottom: 20px; right: 20px; 
            width: 120px; height: 160px; 
            object-fit: cover; z-index: 100; 
            transform: scaleX(-1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            opacity: 0.8;
        }

        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        #status-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; z-index: 20; pointer-events: none;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 12px;
            width: 80%; max-width: 300px; font-size: 16px;
        }

        #interaction-layer {
            position: absolute; bottom: 30px; left: 20px; z-index: 100;
        }
        #hint-text {
            color: rgba(255,255,255,0.8); font-size: 14px; 
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.3);
        }

        /* === æ§åˆ¶é¢æ¿ === */
        #control-panel {
            position: absolute; top: 50px; left: 10px; z-index: 50;
            background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 8px;
            color: white; font-size: 12px; width: 220px;
            backdrop-filter: blur(4px);
            max-height: 70vh; overflow-y: auto;
            display: none; /* é»˜è®¤éšè— */
        }
        .layer-group { 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 10px; margin-bottom: 10px; 
        }
        .control-item { margin-bottom: 5px; }
        .control-item label { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .control-item input { width: 100%; }
        
        #toggle-controls {
            position: absolute; top: 10px; left: 10px; z-index: 51;
            background: rgba(255,255,255,0.2); border: none; color: white;
            padding: 8px 12px; border-radius: 4px; cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="status-box">1. åˆå§‹åŒ–...</div>
    <video id="input-video" playsinline></video>
    <div id="canvas-container"></div>
    <div id="interaction-layer"><div id="hint-text">ğŸµ ç‚¹å‡»æ’­æ”¾éŸ³ä¹</div></div>
    
    <!-- æ§åˆ¶å°å¼€å…³ -->
    <button id="toggle-controls">ğŸ› ï¸ æ‰“å¼€æ§åˆ¶å°</button>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="control-panel">
        <h3 style="margin:0 0 10px 0; color:#ffd700;">å±‚çº§å¾®è°ƒ</h3>
        <!-- JS ä¼šåœ¨è¿™é‡Œç”Ÿæˆæ»‘å— -->
    </div>

    <audio id="bgm" loop><source src="bgm.mp3" type="audio/mpeg"></audio>

    <script src="https://cdn.staticfile.org/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // === é¢„è®¾å‚æ•° (ä½ å¯ä»¥å…ˆåœ¨è¿™é‡Œå¾®è°ƒåˆå§‹å€¼) ===
        const LAYERS_CONFIG = [
            { file: 'pattern_inner.png',  size: 1.5, speed: 0.005, density: 90,  dispScale: 1.0, label: "ç¬¬1å±‚ (å†…)" },
            { file: 'pattern_outer.png',  size: 2.2, speed: 0.004, density: 100, dispScale: 1.2, label: "ç¬¬2å±‚" },
            { file: 'pattern_outer2.png', size: 2.9, speed: 0.003, density: 100, dispScale: 1.4, label: "ç¬¬3å±‚" },
            { file: 'pattern_outer3.png', size: 3.6, speed: 0.002, density: 110, dispScale: 1.6, label: "ç¬¬4å±‚" },
            { file: 'pattern_outer4.png', size: 4.3, speed: 0.001, density: 110, dispScale: 1.8, label: "ç¬¬5å±‚ (å¤–)" }
        ];

        window.onerror = function(msg) {
            document.getElementById('status-box').innerText = "âŒ é”™è¯¯: " + msg;
            return false;
        };

        const statusBox = document.getElementById('status-box');
        const hintText = document.getElementById('hint-text');
        const bgm = document.getElementById('bgm');
        const controlPanel = document.getElementById('control-panel');
        const toggleBtn = document.getElementById('toggle-controls');

        // ç”Ÿæˆ UI
        LAYERS_CONFIG.forEach((config, index) => {
            const div = document.createElement('div');
            div.className = 'layer-group';
            div.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px; color:#aaa;">${config.label}</div>
                <div class="control-item">
                    <label>å¤§å°: <span id="size-val-${index}">${config.size}</span></label>
                    <input type="range" id="size-slider-${index}" min="0.5" max="6.0" step="0.1" value="${config.size}">
                </div>
                <div class="control-item">
                    <label>è½¬é€Ÿ: <span id="speed-val-${index}">${config.speed}</span></label>
                    <input type="range" id="speed-slider-${index}" min="0" max="0.02" step="0.001" value="${config.speed}">
                </div>
            `;
            controlPanel.appendChild(div);
        });

        hintText.addEventListener('click', () => {
            bgm.play().then(() => { hintText.style.display = 'none'; })
               .catch(e => { hintText.innerText = "æ— éŸ³ä¹æ–‡ä»¶"; });
        });

        toggleBtn.addEventListener('click', () => {
            if (controlPanel.style.display === 'none') {
                controlPanel.style.display = 'block';
                toggleBtn.innerText = "âœ– å…³é—­æ§åˆ¶å°";
            } else {
                controlPanel.style.display = 'none';
                toggleBtn.innerText = "ğŸ› ï¸ æ‰“å¼€æ§åˆ¶å°";
            }
        });

        let scene, camera, renderer;
        let systems = []; 
        let targetFactor = 0; 
        let currentFactor = 0;

        window.onload = function() { init(); };

        function init() {
            statusBox.innerText = "2. å¯åŠ¨ 3D å¼•æ“...";
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000); // çº¯é»‘èƒŒæ™¯

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 4.5; 

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            statusBox.innerText = "3. åŠ è½½ 5 å±‚çº¹æ ·...";
            const loader = new THREE.TextureLoader();
            const loadPromises = LAYERS_CONFIG.map(config => loadTexturePromise(loader, config.file));

            Promise.all(loadPromises).then(textures => {
                textures.forEach((tex, index) => {
                    const config = LAYERS_CONFIG[index];
                    const sys = createLayer(tex, config.size, config.density, config.dispScale);
                    sys.rotationSpeed = config.speed;
                    sys.baseSize = config.size;
                    systems.push(sys);
                    scene.add(sys.group);

                    // ç»‘å®šäº‹ä»¶
                    const sizeSlider = document.getElementById(`size-slider-${index}`);
                    const sizeVal = document.getElementById(`size-val-${index}`);
                    const speedSlider = document.getElementById(`speed-slider-${index}`);
                    const speedVal = document.getElementById(`speed-val-${index}`);

                    sizeSlider.addEventListener('input', (e) => {
                        const newSize = parseFloat(e.target.value);
                        sizeVal.innerText = newSize.toFixed(1);
                        const scale = newSize / sys.baseSize;
                        sys.group.scale.set(scale, scale, 1);
                        sys.group.position.z = (6.0 - newSize) * 0.05;
                    });

                    speedSlider.addEventListener('input', (e) => {
                        const newSpeed = parseFloat(e.target.value);
                        speedVal.innerText = newSpeed.toFixed(3);
                        sys.rotationSpeed = newSpeed;
                    });
                });
                
                statusBox.innerText = "4. å¯åŠ¨ AI...";
                startCamera();
            }).catch(err => { 
                statusBox.innerHTML = "âŒ åŠ è½½å¤±è´¥<br>è¯·æ£€æŸ¥5å¼ å›¾ç‰‡æ–‡ä»¶å"; 
            });

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function loadTexturePromise(loader, url) {
            return new Promise((resolve, reject) => { loader.load(url, resolve, undefined, reject); });
        }

  
