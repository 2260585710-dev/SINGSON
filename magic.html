<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½è¯Šæ–­ç‰ˆç²’å­ç³»ç»Ÿ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: monospace; }
        
        /* è°ƒè¯•æ—¥å¿—é¢æ¿ */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; height: auto;
            background: rgba(0,0,0,0.5); color: #0f0; font-size: 10px;
            padding: 5px; pointer-events: none; z-index: 200;
            white-space: pre-wrap; word-break: break-all;
        }

        #ui-container {
            position: absolute; bottom: 20px; left: 20px;
            z-index: 100; color: #ffd700;
            background: rgba(50,50,50,0.8); padding: 10px; border-radius: 8px;
        }
        
        #loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #ffd700; font-size: 16px; border: 1px solid #ffd700;
            padding: 10px 20px; background: rgba(0,0,0,0.8);
            z-index: 150;
        }
        
        .input_video { display: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

    <div id="debug-console">ğŸ” ç³»ç»Ÿæ—¥å¿—å¯åŠ¨...<br></div>

    <div id="ui-container">
        <b>äº¤äº’æ§åˆ¶</b><br>
        <span style="font-size:10px">å¼ å¼€æ‰‹æŒæ‰©æ•£ï¼Œæ¡æ‹³è¿˜åŸ</span>
    </div>

    <div id="loading">æ­£åœ¨å°è¯•åŠ è½½ overlay.png ...</div>
    <video class="input_video"></video>

    <script>
        // --- æ—¥å¿—å·¥å…· ---
        function log(msg) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.innerHTML += `> ${msg}<br>`;
            console.log(msg);
        }

        function error(msg) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.innerHTML += `<span style="color:red; font-weight:bold;">âŒ é”™è¯¯: ${msg}</span><br>`;
        }

        // --- 1. åœºæ™¯åˆå§‹åŒ– ---
        log("åˆå§‹åŒ– 3D åœºæ™¯...");
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.z = 180;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        let particles;
        let originalPositions = [];
        let randomTargets = [];

        // --- 2. å¤‡ç”¨æ–¹æ¡ˆï¼šç”Ÿæˆå¿ƒå½¢å›¾æ¡ˆ ---
        function createHeartFallback() {
            log("âš ï¸ å¯åŠ¨å¤‡ç”¨æ–¹æ¡ˆï¼šç”Ÿæˆå†…ç½®å¿ƒå½¢å›¾æ¡ˆ");
            document.getElementById('loading').innerText = "åŠ è½½å›¾ç‰‡å¤±è´¥ï¼Œå·²åˆ‡æ¢è‡³æ¼”ç¤ºæ¨¡å¼";
            
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const color = new THREE.Color(0xff0055); // çº¢è‰²

            // ç”Ÿæˆå¿ƒå½¢ç‚¹é˜µ
            for (let i = 0; i < 3000; i++) {
                const t = Math.random() * Math.PI * 2;
                // å¿ƒå½¢å…¬å¼
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                
                // éšæœºå¡«å……å†…éƒ¨
                const scale = (Math.random() * 0.8 + 0.2) * 4; 
                
                const pX = x * scale;
                const pY = y * scale;
                const pZ = 0;

                positions.push(pX, pY, pZ);
                originalPositions.push(pX, pY, pZ);
                randomTargets.push((Math.random()-0.5)*400, (Math.random()-0.5)*400, (Math.random()-0.5)*400);
                colors.push(color.r, color.g, color.b);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            createParticleSystem(geometry);
        }

        function createParticleSystem(geometry) {
            const material = new THREE.PointsMaterial({
                size: 1.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
            log("âœ… ç²’å­ç³»ç»Ÿåˆ›å»ºæˆåŠŸï¼");
            document.getElementById('loading').style.display = 'none';
        }

        // --- 3. å°è¯•åŠ è½½å›¾ç‰‡ ---
        log("å¼€å§‹è¯·æ±‚å›¾ç‰‡: ./overlay.png");
        const img = new Image();
        img.src = './overlay.png';
        img.crossOrigin = "Anonymous";

        // è®¾ç½®ä¸€ä¸ª3ç§’çš„è¶…æ—¶è®¡æ—¶å™¨
        // å¦‚æœ3ç§’å†… img.onload æ²¡è§¦å‘ï¼Œå°±è®¤ä¸ºå¤±è´¥ï¼Œç›´æ¥ç”»å¿ƒå½¢
        const timeoutID = setTimeout(() => {
            log("â° å›¾ç‰‡åŠ è½½è¶…æ—¶ (3ç§’æ— å“åº”)");
            if (!particles) createHeartFallback();
        }, 3000);

        img.onload = function() {
            clearTimeout(timeoutID); // å–æ¶ˆè¶…æ—¶è®¡æ—¶
            log(`å›¾ç‰‡åŠ è½½æˆåŠŸ! å°ºå¯¸: ${img.width}x${img.height}`);
            
            try {
                log("å°è¯•åˆ›å»º Canvas å¹¶è¯»å–åƒç´ ...");
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const targetWidth = 300; 
                const scale = targetWidth / img.width; 
                canvas.width = targetWidth;
                canvas.height = img.height * scale;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // è¿™é‡Œæœ€å®¹æ˜“å‡ºé”™ (è·¨åŸŸå®‰å…¨ç­–ç•¥)
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                log("åƒç´ æ•°æ®è¯»å–æˆåŠŸï¼å¼€å§‹ç”Ÿæˆç²’å­...");

                const geometry = new THREE.BufferGeometry();
                const positions = [];
                const colors = [];
                const baseColor = new THREE.Color(0xffd700); // å¼ºåˆ¶é‡‘è‰²

                let count = 0;
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const i = (y * canvas.width + x) * 4;
                        if (data[i + 3] > 20) { // ä¸é€æ˜åº¦åˆ¤æ–­
                            const pX = (x - canvas.width / 2) * 1.2;
                            const pY = -(y - canvas.height / 2) * 1.2;
                            positions.push(pX, pY, 0);
                            originalPositions.push(pX, pY, 0);
                            randomTargets.push((Math.random()-0.5)*400, (Math.random()-0.5)*400, (Math.random()-0.5)*400);
                            
                            // é¢œè‰²
                            const v = Math.random() * 0.5 + 0.5;
                            colors.push(baseColor.r * v, baseColor.g * v, baseColor.b * v);
                            count++;
                        }
                    }
                }
                
                log(`æå–åˆ° ${count} ä¸ªç²’å­ç‚¹`);
                if (count === 0) {
                    error("å›¾ç‰‡å…¨æ˜¯é€æ˜çš„ï¼Ÿæ²¡æœ‰æå–åˆ°ç‚¹");
                    createHeartFallback();
                    return;
                }

                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                
                createParticleSystem(geometry);

            } catch (e) {
                error("å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™: " + e.message);
                createHeartFallback();
            }
        };

        img.onerror = function() {
            clearTimeout(timeoutID);
            error("æ‰¾ä¸åˆ°å›¾ç‰‡ ./overlay.png (404)");
            createHeartFallback();
        };

        // --- æ‰‹åŠ¿ ---
        let handOpenness = 0; 
        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const dist = Math.sqrt(Math.pow(lm[4].x - lm[8].x, 2) + Math.pow(lm[4].y - lm[8].y, 2));
                handOpenness = Math.max(0, Math.min(1, (dist - 0.04) * 3));
            } else {
                handOpenness *= 0.9;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (particles) {
                const pos = particles.geometry.attributes.position.array;
                for (let i = 0; i < pos.length; i += 3) {
                    const tx = originalPositions[i] + (randomTargets[i] / 400 * 300) * handOpenness;
                    const ty = originalPositions[i+1] + (randomTargets[i+1] / 400 
